C_SRC = ble-nrf51822-master/source/nordic_sdk/components/ble/ble_radio_notification/ble_radio_notification.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/ble_services/ble_dfu/ble_dfu.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/common/ble_advdata.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/common/ble_conn_state.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/common/ble_srv_common.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/device_manager/device_manager_peripheral.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager/id_manager.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager/peer_data.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager/peer_database.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager/peer_data_storage.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager/peer_id.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager/pm_buffer.c \
ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager/pm_mutex.c \
ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/ble_flash/ble_flash.c \
ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/delay/nrf_delay.c \
ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/hal/nrf_ecb.c \
ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/hal/nrf_nvmc.c \
ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/pstorage/pstorage.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/bootloader_dfu/bootloader_util.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/bootloader_dfu/dfu_app_handler.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/bootloader_dfu/dfu_init_template.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/crc16/crc16.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/fds/fds.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/fstorage/fstorage.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/fstorage/fstorage_nosd.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/hci/hci_mem_pool.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/scheduler/app_scheduler.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/util/app_error.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/util/app_util_platform.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/util/nrf_assert.c \
ble-nrf51822-master/source/nordic_sdk/components/libraries/util/sdk_mapped_flags.c \
ble-nrf51822-master/source/nordic_sdk/components/softdevice/common/softdevice_handler/softdevice_handler.c \
ble-nrf51822-master/source/nordic_sdk/components/softdevice/common/softdevice_handler/softdevice_handler_appsh.c \
mbed/common/assert.c \
mbed/common/board.c \
mbed/common/error.c \
mbed/common/gpio.c \
mbed/common/lp_ticker_api.c \
mbed/common/mbed_interface.c \
mbed/common/pinmap_common.c \
mbed/common/rtc_time.c \
mbed/common/semihost_api.c \
mbed/common/ticker_api.c \
mbed/common/us_ticker_api.c \
mbed/common/wait_api.c \
mbed/targets/cmsis/TARGET_NORDIC/TARGET_MCU_NRF51822/cmsis_nvic.c \
mbed/targets/cmsis/TARGET_NORDIC/TARGET_MCU_NRF51822/system_nrf51.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/analogin_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/gpio_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/gpio_irq_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/i2c_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/pinmap.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/port_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/pwmout_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/serial_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/sleep.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/spi_api.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/twi_master.c \
mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/us_ticker.c 


CPP_SRC = mbed/common/BusIn.cpp \
mbed/common/BusInOut.cpp \
mbed/common/BusOut.cpp \
mbed/common/CallChain.cpp \
mbed/common/CAN.cpp \
mbed/common/Ethernet.cpp \
mbed/common/FileBase.cpp \
mbed/common/FileLike.cpp \
mbed/common/FilePath.cpp \
mbed/common/FileSystemLike.cpp \
mbed/common/I2C.cpp \
mbed/common/I2CSlave.cpp \
mbed/common/InterruptIn.cpp \
mbed/common/InterruptManager.cpp \
mbed/common/LocalFileSystem.cpp \
mbed/common/RawSerial.cpp \
mbed/common/retarget.cpp \
mbed/common/Serial.cpp \
mbed/common/SerialBase.cpp \
mbed/common/SPI.cpp \
mbed/common/SPISlave.cpp \
mbed/common/Stream.cpp \
mbed/common/Ticker.cpp \
mbed/common/Timeout.cpp \
mbed/common/Timer.cpp \
mbed/common/TimerEvent.cpp \
ble-master/source/BLE.cpp \
ble-master/source/DiscoveredCharacteristic.cpp \
ble-master/source/GapScanningParams.cpp \
ble-master/source/services/DFUService.cpp \
ble-master/source/services/UARTService.cpp \
ble-master/source/services/URIBeaconConfigService.cpp \
ble-nrf51822-master/source/btle/btle.cpp \
ble-nrf51822-master/source/btle/btle_advertising.cpp \
ble-nrf51822-master/source/btle/btle_discovery.cpp \
ble-nrf51822-master/source/btle/btle_gap.cpp \
ble-nrf51822-master/source/btle/btle_security.cpp \
ble-nrf51822-master/source/btle/custom/custom_helper.cpp \
ble-nrf51822-master/source/nordic_sdk/components/ble/common/ble_conn_params.cpp \
ble-nrf51822-master/source/nRF5xCharacteristicDescriptorDiscoverer.cpp \
ble-nrf51822-master/source/nRF5xDiscoveredCharacteristic.cpp \
ble-nrf51822-master/source/nRF5xGap.cpp \
ble-nrf51822-master/source/nRF5xGattClient.cpp \
ble-nrf51822-master/source/nRF5xGattServer.cpp \
ble-nrf51822-master/source/nRF5xn.cpp \
ble-nrf51822-master/source/nRF5xServiceDiscovery.cpp

# MCU name and submodel
MCU      = cortex-m3

# toolchain (using code sourcery now)
TCHAIN = arm-none-eabi
THUMB    = -mthumb
THUMB_IW = -mthumb-interwork

# Target file name (without extension).
BUILDDIR = .
TARGET = $(BUILDDIR)

BLE_API = ./ble-master ./ble-master/ble/services ./ble-master/source ./ble-master/source/services 
NRF51822_API = ./ble-nrf51822-master/source ./ble-nrf51822-master/source/btle ./ble-nrf51822-master/source/btle/custom ./ble-nrf51822-master/source/common ./ble-nrf51822-master/source/nordic_sdk/components/ble/ble_radio_notification ./ble-nrf51822-master/source/nordic_sdk/components/ble/ble_services/ble_dfu ./ble-nrf51822-master/source/nordic_sdk/components/ble/common ./ble-nrf51822-master/source/nordic_sdk/components/ble/device_manager ./ble-nrf51822-master/source/nordic_sdk/components/ble/device_manager/config ./ble-nrf51822-master/source/nordic_sdk/components/ble/peer_manager ./ble-nrf51822-master/source/nordic_sdk/components/device ./ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/ble_flash ./ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/delay ./ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/hal ./ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/pstorage ./ble-nrf51822-master/source/nordic_sdk/components/drivers_nrf/pstorage/config ./ble-nrf51822-master/source/nordic_sdk/components/libraries/bootloader_dfu ./ble-nrf51822-master/source/nordic_sdk/components/libraries/bootloader_dfu/hci_transport ./ble-nrf51822-master/source/nordic_sdk/components/libraries/crc16 ./ble-nrf51822-master/source/nordic_sdk/components/libraries/experimental_section_vars ./ble-nrf51822-master/source/nordic_sdk/components/libraries/fds ./ble-nrf51822-master/source/nordic_sdk/components/libraries/fstorage ./ble-nrf51822-master/source/nordic_sdk/components/libraries/hci ./ble-nrf51822-master/source/nordic_sdk/components/libraries/scheduler ./ble-nrf51822-master/source/nordic_sdk/components/libraries/timer ./ble-nrf51822-master/source/nordic_sdk/components/libraries/util ./ble-nrf51822-master/source/nordic_sdk/components/softdevice/common/softdevice_handler ./ble-nrf51822-master/source/nordic_sdk/components/softdevice/s130/headers
MBED_API = ./mbed/api ./mbed/common ./mbed/hal ./mbed/targets/cmsis ./mbed/targets/cmsis/TARGET_NORDIC/TARGET_MCU_NRF51822/ ./mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822 ./mbed/targets/hal/TARGET_NORDIC/TARGET_MCU_NRF51822/TARGET_RBLAB_NRF51822
INCDIRS =  $(BLE_API) $(NRF51822_API) $(MBED_API)

# Optimization level [0,1,2,3,s]
OPT ?= s
DEBUG = 

CPPFLAGS = $(DEBUG)
CPPFLAGS += -c -g -Os -w -std=gnu++98 -fno-common -fmessage-length=0 -Wall -fno-exceptions -ffunction-sections -fdata-sections -fomit-frame-pointer -nostdlib --param max-inline-insns-single=500 -fno-rtti -DBLE_STACK_SUPPORT_REQD -DDEBUG_NRF_USER -DNRF51 -DNRF51_S130 -DTARGET_NRF51822 -DTARGET_M0 -DTARGET_CORTEX_M -DTARGET_NORDIC -DTARGET_NRF51822_MKIT -DTARGET_MCU_NRF51822 -DTOOLCHAIN_GCC_ARM -DTOOLCHAIN_GCC -D__CORTEX_M0 -DARM_MATH_CM0 -DMBED_BUILD_TIMESTAMP=1435023129.97 -D__MBED__=1 -mcpu=cortex-m0 -DF_CPU=16000000 -DARDUINO=10609 -DARDUINO_Generic_nRF51822 -DARDUINO_ARCH_RBL_NRF51822 -mthumb 
CPPFLAGS += $(patsubst %,-I%,$(INCDIRS))

CFLAGS = $(DEBUG)
CFLAGS += -c -g -Os -w   -std=gnu99 -fno-common -fmessage-length=0 -Wall -fno-exceptions -ffunction-sections -fdata-sections -fomit-frame-pointer -nostdlib --param max-inline-insns-single=500 		  -DBLE_STACK_SUPPORT_REQD -DDEBUG_NRF_USER -DNRF51 -DNRF51_S130 -DTARGET_NRF51822 -DTARGET_M0 -DTARGET_CORTEX_M -DTARGET_NORDIC -DTARGET_NRF51822_MKIT -DTARGET_MCU_NRF51822 -DTOOLCHAIN_GCC_ARM -DTOOLCHAIN_GCC -D__CORTEX_M0 -DARM_MATH_CM0 -DMBED_BUILD_TIMESTAMP=1435023129.97 -D__MBED__=1 -mcpu=cortex-m0 -DF_CPU=16000000 -DARDUINO=10609 -DARDUINO_Generic_nRF51822 -DARDUINO_ARCH_RBL_NRF51822 -mthumb 
CFLAGS += $(patsubst %,-I%,$(INCDIRS))

# Aeembler Flags
ASFLAGS = -Wa,-adhlns=$(BUILDDIR)/$(<:.s=.lst)#,--g$(DEBUG)

LDFLAGS = -nostartfiles -Wl,-Map=$(TARGET).map,--cref,--gc-sections
LDFLAGS += -lc -lgcc

# Define programs and commands.
SHELL = sh
CC = $(TCHAIN)-gcc
CCPP = $(TCHAIN)-g++
AR = $(TCHAIN)-ar
OBJCOPY = $(TCHAIN)-objcopy
OBJDUMP = $(TCHAIN)-objdump
SIZE = $(TCHAIN)-size
NM = $(TCHAIN)-nm
REMOVE = rm -f
REMOVEDIR = rm -r
COPY = cp

# Define Messages
# English
MSG_ERRORS_NONE = Errors: none
MSG_BEGIN = "-------- begin --------"
MSG_END = --------  end  --------
MSG_LINKING = Linking:
MSG_COMPILING = Compiling C:
MSG_COMPILING_CPP = Compiling CPP:
MSG_ASSEMBLING = Assembling:
MSG_CLEANING = Cleaning project:

# Combine all necessary flags and optional flags.
# Add target processor to flags.
#GENDEPFLAGS = -MD -MP -MF .dep/$(@F).d
ALL_CFLAGS  =  $(CFLAGS)  
ALL_CPPFLAGS  =  $(CPPFLAGS) 
ALL_ASFLAGS = -g -mcpu=$(MCU) $(THUMB_IW) -I. -x assembler-with-cpp $(ASFLAGS)

# Define all object files.
_CPPOBJ =  $(CPP_SRC:.cpp=.o)
_COBJ =  $(C_SRC:.c=.o)
_AOBJ =  $(ASRC:.s=.o)
COBJ = $(patsubst %, $(BUILDDIR)/%,$(_COBJ))
CPPOBJ = $(patsubst %, $(BUILDDIR)/%,$(_CPPOBJ))
AOBJ = $(patsubst %, $(BUILDDIR)/%,$(_AOBJ))

# Define all listing files.
_LST  =  $(ASRC:.s=.lst)
_LST +=  $(C_SRC:.c=.lst)
_LST +=  $(CPP_SRC:.cpp=.lst)
LST = $(patsubst %, $(BUILDDIR)/%,$(_LST))

# go!
all:  bin lib end
	
bin: $(COBJ) $(CPPOBJ) $(AOBJ)
	
lib:
	@echo
	@echo "Building static lib nrf51822_core.a"
	$(AR) rcs nrf51822_core.a $(COBJ) $(CPPOBJ)

end:
	@echo $(MSG_END)
	@echo
	
# Create final output file (.bin) from ELF output file.
%.bin:  $(COBJ) $(CPPOBJ) $(AOBJ)


# Compile: create object files from CPP source files. 
$(CPPOBJ) : $(BUILDDIR)/%.o : %.cpp
	@echo
	@echo $(MSG_COMPILING_CPP) $<
	$(CCPP) $(ALL_CPPFLAGS) $< -o $@
	
# Compile: create object files from C source files.
$(COBJ) : $(BUILDDIR)/%.o : %.c
	@echo
	@echo $(MSG_COMPILING) $<
	$(CC)  $(ALL_CFLAGS) $< -o $@

 Assemble: create object files from assembler source files. ARM/Thumb
$(AOBJ) : $(BUILDDIR)/%.o : %.s
	@echo
	@echo $(MSG_ASSEMBLING) $<
	$(CC) -c $(THUMB) $(ALL_ASFLAGS) $< -o $@

clean:  
	@echo
	@echo $(MSG_CLEANING)
	$(REMOVE) $(COBJ)
	$(REMOVE) $(CPPOBJ)
	$(REMOVE) $(AOBJ)
	$(REMOVE) $(LST)
	$(REMOVE) .dep/*
